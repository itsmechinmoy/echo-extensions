name: Spotify Secret Workflow

on:
  workflow_dispatch:

jobs:
  extract-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium
          pip install webdriver-manager

      - name: Install Tampermonkey extension and script
        run: |
          wget -O tampermonkey.crx https://clients2.google.com/service/update2/crx?response=redirect&prodversion=114.0&x=id=mgjgjhfbjcbkebppmcndlagpnpbhikff&uc
          google-chrome --install-extension=tampermonkey.crx
          cp tampermonkey_script.js /usr/lib/chromium-browser/extensions/

      - name: Run Selenium script
        run: |
          python - <<EOF
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from webdriver_manager.chrome import ChromeDriverManager

          chrome_options = Options()
          chrome_options.add_argument('--headless')
          chrome_options.add_argument('--no-sandbox')
          chrome_options.add_argument('--disable-dev-shm-usage')
          driver = webdriver.Chrome(options=chrome_options, executable_path=ChromeDriverManager().install())

          try:
              driver.get('https://open.spotify.com/')
              time.sleep(10)  # Wait for page to load and script to execute
              secret = driver.execute_script('return JSON.stringify(window.TOKENS.secrets[1])')
              with open('noidea.txt', 'w') as f:
                  f.write(secret)
              print('Secret extracted:', secret)
          finally:
              driver.quit()
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add noidea.txt
          git commit -m "Update secrets [skip ci]"
          git push
