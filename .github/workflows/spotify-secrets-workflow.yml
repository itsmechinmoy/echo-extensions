name: Spotify Secret Workflow
on:
  workflow_dispatch:
jobs:
  extract-secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium
          pip install webdriver-manager

      - name: Verify tampermonkey_script.js
        run: |
          if [ ! -f "tampermonkey_script.js" ]; then
            echo "Error: tampermonkey_script.js not found in repository root. Please ensure it is committed to the main branch."
            exit 1
          fi

      - name: Run Selenium script
        run: |
          python - <<EOF
          import time
          import os
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.common.exceptions import TimeoutException

          chrome_options = Options()
          # Remove headless to emulate a regular browser
          # chrome_options.add_argument('--headless')  # Commented out
          chrome_options.add_argument('--no-sandbox')
          chrome_options.add_argument('--disable-dev-shm-usage')
          chrome_options.add_argument('--window-size=1920,1080')  # Set a visible window size
          # Removed --user-data-dir to let Selenium manage it

          driver = webdriver.Chrome(options=chrome_options)

          # Inject the script before navigating
          with open('tampermonkey_script.js', 'r') as f:
              script_content = f.read()
          driver.execute_script(script_content)

          try:
              driver.get('https://open.spotify.com/')
              # Wait until TOKENS is defined or timeout after 30 seconds
              wait = WebDriverWait(driver, 30)
              wait.until(lambda d: d.execute_script('return window.TOKENS !== undefined'))
              time.sleep(5)  # Additional buffer after TOKENS is detected
              secret = driver.execute_script('return JSON.stringify(window.TOKENS.secrets[1])')
              with open('noidea.txt', 'w') as f:
                  f.write(secret)
              print('Secret extracted:', secret)
          except TimeoutException:
              print('Error: Timed out waiting for window.TOKENS to be defined.')
              driver.save_screenshot('timeout_screenshot.png')  # Save screenshot for debugging
              raise
          except Exception as e:
              print(f'Error: {str(e)}')
              driver.save_screenshot('error_screenshot.png')  # Save screenshot for debugging
              raise
          finally:
              driver.quit()
              # Optional: Clean up any temporary files if needed
              import shutil
              if os.path.exists('/tmp/chrome-user-data'):
                  shutil.rmtree('/tmp/chrome-user-data', ignore_errors=True)
          EOF

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add noidea.txt
          git commit -m "Update secrets [skip ci]" || echo "No changes to commit"
          git push
