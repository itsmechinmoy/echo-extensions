name: Spotify Secrets Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC

jobs:
  extract-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Install Tampermonkey script
        run: |
          echo "Installing Tampermonkey script..."
          mkdir -p tampermonkey_scripts
          curl -o tampermonkey_scripts/spotify_secrets.user.js https://raw.githubusercontent.com/itsmechinmoy/echo-extensions/main/spotify_secrets.user.js
          # Note: The script provided needs to be saved as spotify_secrets.user.js in the repo

      - name: Run Selenium script
        env:
          CHROME_BIN: /usr/bin/chromium-browser
          CHROMEDRIVER_PATH: /usr/bin/chromedriver
        run: |
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from webdriver_manager.chrome import ChromeDriverManager
          import time
          import json

          options = webdriver.ChromeOptions()
          options.binary_location = '/usr/bin/chromium-browser'
          options.add_argument('--headless')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

          try:
              driver.get('https://open.spotify.com/')
              time.sleep(10)  # Wait for page to load and script to execute

              # Execute the console command
              secret = driver.execute_script('return JSON.stringify(window.TOKENS.secrets[1])')
              secret_data = json.loads(secret)

              # Read existing secrets
              with open('noidea.txt', 'r') as file:
                  existing_secrets = json.load(file)

              # Append new secret if not already present
              if not any(s.get('secret') == secret_data.get('secret') for s in existing_secrets):
                  existing_secrets.append(secret_data)

              # Write updated secrets back to file
              with open('noidea.txt', 'w') as file:
                  json.dump(existing_secrets, file, indent=2)

              print('Secret extracted and updated:', secret_data)

          finally:
              driver.quit()"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add noidea.txt
          git commit -m "Update secrets with new Spotify token" || echo "No changes to commit"
          git push
