name: Spotify Secrets Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC

jobs:
  extract-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          # Get Chrome version for driver compatibility
          CHROME_VERSION=$(google-chrome --version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
          wget -N "https://chromedriver.storage.googleapis.com/${CHROME_VERSION}/chromedriver-linux64.zip" -P ~/
          unzip -o ~/chromedriver-linux64.zip -d ~/
          chmod +x ~/chromedriver
          sudo mv ~/chromedriver /usr/local/bin/chromedriver

      - name: Install Tampermonkey script
        run: |
          mkdir -p tampermonkey_scripts
          curl -o tampermonkey_scripts/spotify_secrets.user.js https://raw.githubusercontent.com/itsmechinmoy/echo-extensions/main/spotify_secrets.user.js

      - name: Run Selenium script
        env:
          CHROME_BIN: /usr/bin/google-chrome
          CHROMEDRIVER_PATH: /usr/local/bin/chromedriver
        run: |
          python -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from webdriver_manager.chrome import ChromeDriverManager
          import time
          import json

          options = webdriver.ChromeOptions()
          options.binary_location = '/usr/bin/google-chrome'
          options.add_argument('--headless')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          options.add_argument('--disable-gpu')
          options.add_argument('--remote-debugging-port=0')
          options.add_argument('--window-size=1920,1080')
          options.add_argument('--disable-setuid-sandbox')
          driver = webdriver.Chrome(service=Service('/usr/local/bin/chromedriver'), options=options)

          try:
              driver.get('https://open.spotify.com/')
              time.sleep(2)  # Short initial wait for page to start loading
              
              # Inject the original Tampermonkey script
              with open('tampermonkey_scripts/spotify_secrets.user.js', 'r') as file:
                  script_content = file.read()
              driver.execute_script(script_content)
              
              time.sleep(15)  # Wait for script to execute and populate TOKENS
              
              # Execute the console command to get the secret
              secret = driver.execute_script('return JSON.stringify(window.TOKENS?.secrets?.[1])')
              if secret:
                  secret_data = json.loads(secret)
                  with open('noidea.txt', 'r') as file:
                      existing_secrets = json.load(file)

                  if not any(s.get('secret') == secret_data.get('secret') for s in existing_secrets):
                      existing_secrets.append(secret_data)

                  with open('noidea.txt', 'w') as file:
                      json.dump(existing_secrets, file, indent=2)

                  print('Secret extracted and updated:', secret_data)
              else:
                  print('No secret found in TOKENS.secrets[1]')

          except Exception as e:
              print('Error occurred:', str(e))
          finally:
              driver.quit()"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add noidea.txt
          git commit -m "Update secrets with new Spotify token" || echo "No changes to commit"
          git push
